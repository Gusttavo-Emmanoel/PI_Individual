<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha</title>

    <link rel="stylesheet" href="style/estrutura.css">
    <link rel="stylesheet" href="style/ficha.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap"
        rel="stylesheet">
</head>

<body onload="listar_informacoes()">
   <header>
        <div class="logo_texto">
            T<b>ROLL</b>
        </div>


        <nav>
            <a href="index.html" class="nav_item ">
                <img src="img/inicio.svg" alt="icone de inicio">
                <span>Inicio</span>
            </a>
            <a href="como_jogar.html" class=" nav_item">
                <img src="img/como_jogar.svg" alt="icone de como_jogar">
                <span>Como Jogar</span>
            </a>
            <a href="./ficha.html" class="nav_select">
                <img src="img/criar_ficha-selecionado.svg" alt="icone de ficha">
                <span>Ficha</span>
            </a>
            <a href="login.html" class="btn_secundario">
                <span>Entrar</span>
            </a>
            <a href="cadastro.html" class="btn_primario">
                <span>Criar conta</span>
            </a>
        </nav>
    </header>

    <main>
        <section>
            <h1>Criação de Ficha</h1>
        </section>

        <section>
            Informe o nome de seu personagem: <input id="ipt_nome">
        </section>

        <section class="classe_raca">
            <div>
                <h2>Selecione uma classe</h2>
                <select onclick="selecionar_classe()" id="slc_classe">
                </select>

                <div id="info_classe">

                </div>


            <div>
                <h2>Selecione uma raça</h2>
                <select onclick="selecionar_raca()" id="slc_raca">
                </select>
                <br><br>

                <div id="msg_raca"></div>

            </div>
        </section>

        <section>
            <h2>Destribuição de pontos de atributo</h2>
            <div class="atributo">
                <div class="atributo_item">
                    <h3>Força</h3>
                    <div class="atributo_pontos" id="vs_for_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_for_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_for_pontos , vs_for_bonus, 'meio-orc_for')"> Rolar Pontos</button>
                </div>

                <div class="atributo_item">
                    <h3>Destreza</h3>
                    <div class="atributo_pontos" id="vs_des_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_des_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_des_pontos , vs_des_bonus, 'elfo_des')"> Rolar Pontos</button>
                </div>

                <div class="atributo_item">
                    <h3>Constituição</h3>
                    <div class="atributo_pontos" id="vs_con_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_con_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_con_pontos , vs_con_bonus, 'meio-orc_con')"> Rolar Pontos</button>
                </div>

                <div class="atributo_item">
                    <h3>Inteligência</h3>
                    <div class="atributo_pontos" id="vs_int_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_int_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_int_pontos , vs_int_bonus, 'elfo_int')"> Rolar Pontos</button>
                </div>

                <div class="atributo_item">
                    <h3>Sabedoria</h3>
                    <div class="atributo_pontos" id="vs_sab_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_sab_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_sab_pontos , vs_sab_bonus)"> Rolar Pontos</button>
                </div>

                <div class="atributo_item">
                    <h3>Carisma</h3>
                    <div class="atributo_pontos" id="vs_car_pontos">
                        8
                    </div>
                    <div class="atributo_bonus" id="vs_car_bonus">
                        -1
                    </div>

                    <button onclick="rolar_pontos(vs_car_pontos , vs_car_bonus)"> Rolar Pontos</button>
                </div>

            </div>

            <button onclick="salvar()">Salvar</button>

        </section>

    </main>

</body>
<script>
    let listaClasses = [];
    let listaArmas = [];
    let listaArmaduras = [];
    let listaRaca = [];

    function selecionar_classe(){
        let id_classe = Number(slc_classe.value);
        let classe;

        for(let i = 0; i < listaClasses.length; i++){
            
            if(listaClasses[i].id_classe == id_classe){
                classe = listaClasses[i];
            }
        }

        if(classe != null) {
            let optionArma;
            let optionArmadura;

            if(classe.listaArmas != null){
                for(let i = 0; i < classe.listaArmas.length; i++){
                    optionArma += `<option value="${classe.listaArmas[i].id_arma}">${classe.listaArmas[i].nome}</option>`;
                }
            }

            if(classe.listaArmaduras != null){
                for(let i = 0; i < classe.listaArmaduras.length; i++){
                    optionArmadura += `<option value="${classe.listaArmaduras[i].id_armadura}">${classe.listaArmaduras[i].nome}</option>`;
                }
            }


            info_classe.innerHTML = `
                <h3>Equipamentos de ${classe.nome}</h3>
                <select id="slc_arma">
                    ${optionArma}
                </select>
                <select id="slc_armadura">
                    ${optionArmadura}
                </select>`;

        }
    }

    function selecionar_raca() {

        let humano = {
            atributo: '+1 em todas os atributos.',
            descricao: 'Os humanos são bem versáteis.'
        }
        let elfo = {
            atributo: '+2 em Destreza e +1 em Inteligência.',
            descricao: 'Os Elfos são otimos Ladinos e Magos.'
        }
        let meio_orc = {
            atributo: '+2 em Força e +1 em Constituição.',
            descricao: 'Os Meio-Orcs são os melhores guerreiros.'
        }

        msg_raca.innerHTML = ''
        if (slc_raca.value == 'Humano') {
            msg_raca.innerHTML = `Atributo: ${humano.atributo} <br> Descrição: ${humano.descricao}`
        } else if (slc_raca.value == 'Elfo') {
            msg_raca.innerHTML = `Atributo: ${elfo.atributo} <br> Descrição: ${elfo.descricao}`
        } else if (slc_raca.value == 'Meio-Orc') {
            msg_raca.innerHTML = `Atributo: ${meio_orc.atributo} <br> Descrição: ${meio_orc.descricao}`
        }
    }

    function selecionar_raca2(){
        console.log("selecionado")
    }

    function rolar_pontos(n1, n2, n3) {
        let pontos = Number((Math.random() * 8 + 8).toFixed(0));
        let bonus

        if (slc_raca.value == "Humano") {
            pontos++
        } else if (slc_raca.value == "Elfo") {
            if (n3 == "elfo_des") {
                pontos = pontos + 2
            } else if (n3 == "elfo_int") {
                pontos++
            }

        } else if (slc_raca.value == 'Meio-Orc') {
            if (n3 == 'meio-orc_for') {
                pontos = pontos + 2
            } else if (n3 == 'meio-orc_con') {
                pontos++
            }
        }

        n1.innerHTML = pontos;

        for (let i = 8; i <= pontos; i++) {
            if (i == 8) {
                bonus = -1
            } else if (i == i && i % 2 == 0) {
                bonus++
            }
        }

        if (bonus > 0) {
            n2.innerHTML = `+${bonus}`;
        } else {
            n2.innerHTML = `${bonus}`;
        }
    }

    function listar_classes(){
        fetch("/classes/listar", {
            method: "GET"

        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(classes){
                    listaClasses = classes;
                    
                    listar_armas();
                    listar_armaduras();

                    slc_classe.innerHTML += `<option value="#">Selecione</option>`

                    for (var i = 0; i < listaClasses.length; i++){
                        let classe = listaClasses[i];

                        slc_classe.innerHTML += `<option value="${classe.id_classe}">${classe.nome}</option>`
                    }

                })
            }


        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function listar_armas(){
        fetch("/armas/listar", {
            method: "GET"
        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(armas){
                    listaArmas = armas;

                    listar_arma_classe();
                })
            }
        });
    }

    function listar_arma_classe(){
        fetch("/armaClasses/listar", {
            method: "GET"
        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(armasClasses){

                    for(var i = 0; i < listaClasses.length; i++){
                        var classe = listaClasses[i];

                        classe.listaArmas = [];
                        
                        for(j = 0; j < armasClasses.length; j++){
                            var armaClasse = armasClasses[j];
                            
                            if(classe.id_classe == armaClasse.fk_classe){
                                
                                for(k = 0; k < listaArmas.length; k++){
                                    var arma = listaArmas[k];

                                    if(armaClasse.fk_arma == arma.id_arma){
                                        classe.listaArmas.push(arma);
                                    }
                                }
                            }
                        }
                    }
                })
            }
        });
    }

    function listar_armaduras(){
        fetch("/armaduras/listar", {
            method: "GET"
        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(armaduras){
                    listaArmaduras = armaduras;

                    listar_armadura_classe();                    
                })
            }
        });
    }

    function listar_armadura_classe(){
        fetch("/armaduraClasses/listar", {
            method: "GET"
        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(armaduraClasses){

                    for(var i = 0; i < listaClasses.length; i++){
                        var classe = listaClasses[i];

                        classe.listaArmaduras = [];
                        
                        for(j = 0; j < armaduraClasses.length; j++){
                            var armaduraClasse = armaduraClasses[j];
                            
                            if(classe.id_classe == armaduraClasse.fk_classe){
                                
                                for(k = 0; k < listaArmaduras.length; k++){
                                    var armadura = listaArmaduras[k];

                                    if(armaduraClasse.fk_armadura == armadura.id_armadura){
                                        classe.listaArmaduras.push(armadura);
                                    }
                                }
                            }
                        }
                    }
                })
            }
        });
    }

    function listar_racas(){
        fetch("/racas/listar", {
            method: "GET"

        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(raca){
                    listaRaca = raca;

                    slc_raca.innerHTML += `<option value="#">Selecione</option>`

                    for (var i = 0; i < listaRaca.length; i++){
                        let raca = listaRaca[i];

                        slc_raca.innerHTML += `<option value="${raca.id_raca}">${raca.nome}</option>`
                    }

                })
            }


        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function listar_informacoes(){
        listar_classes();
        listar_racas();
    }

    function salvar(){
        let forca = Number(document.getElementById('vs_for_pontos').textContent);
        let destreza = Number(document.getElementById('vs_des_pontos').textContent);
        let constituicao = Number(document.getElementById('vs_con_pontos').textContent);
        let inteligencia = Number(document.getElementById('vs_int_pontos').textContent);
        let sabedoria = Number(document.getElementById('vs_sab_pontos').textContent);
        let carisma = Number(document.getElementById('vs_car_pontos').textContent);
        
        let ficha = {
            nome: document.getElementById('ipt_nome').value,
            fk_usuario: sessionStorage.ID_USUARIO,
            fk_classe: slc_classe.value,
            fk_raca: slc_raca.value,
            atributo: {
                forca: forca,
                destreza: destreza,
                constituicao: constituicao,
                inteligencia: inteligencia,
                sabedoria: sabedoria,
                carisma: carisma
            }
        };

        console.log(ficha);

        salvar_atributo(ficha);
    }

    function salvar_atributo(ficha){
        fetch("/atributos/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(ficha.atributo)
        
        }).then(function(resposta){ 
            resposta.json().then(function(resultado){
                ficha.fk_atributo = resultado.insertId

                salvar_ficha(ficha);
            })

        }).catch(function(erro){
            console.log(erro);
        });
    }

    function salvar_ficha(ficha){
        fetch("/fichas/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(ficha)
        
        }).then(function(resposta){ 
            resposta.json().then(function(resultado){
                console.log(resultado.insertId)
            })

        }).catch(function(erro){
            console.log(erro);
        });
    }

</script>

</html>